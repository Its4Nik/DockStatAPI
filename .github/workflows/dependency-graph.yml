name: Generate Dependency Graph

on:
  push:

permissions: write-all

jobs:
  generate:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install madge
        run: npm install -g madge

      - name: Generate Dependency Data
        run: madge --json src/index.ts > dependencies.json

      - name: Generate Mermaid Markdown
        run: node .github/scripts/generate-mermaid.js

      - name: Commit and Push Changes
        uses: EndBug/add-and-commit@v9
        with:
          add: "dependencies.md"
          message: "CI/CD: Update dependency graph"
          committer_name: "GitHub Action"
          committer_email: "action@github.com"
